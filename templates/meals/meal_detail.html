{% extends 'base.html' %}

{% block title %}{{ meal.strMeal }} - FlavorFinder{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                <li class="breadcrumb-item active">{{ meal.strMeal }}</li>
            </ol>
        </nav>
        
        <h1 class="mb-3">{{ meal.strMeal }}</h1>
        
        <div class="mb-4">
            <img src="{{ meal.strMealThumb }}" alt="{{ meal.strMeal }}" class="img-fluid rounded">
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h4 mb-0">Information</h2>
            </div>
            <div class="card-body">
                <p><strong>Category:</strong> {{ meal.strCategory }}</p>
                <p><strong>Area:</strong> {{ meal.strArea }}</p>
                {% if meal.strTags %}
                <p><strong>Tags:</strong> {{ meal.strTags }}</p>
                {% endif %}
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h4 mb-0">Instructions</h2>
            </div>
            <div class="card-body">
                <p>{{ meal.strInstructions|linebreaks }}</p>
            </div>
        </div>
        
        {% if meal.strYoutube %}
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h4 mb-0">Video Tutorial</h2>
            </div>
            <div class="card-body">
                <div class="ratio ratio-16x9">
                    {% with youtube_id=meal.strYoutube|cut:'https://www.youtube.com/watch?v=' %}
                        <iframe src="https://www.youtube.com/embed/{{ youtube_id }}" allowfullscreen></iframe>
                    {% endwith %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-md-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header">
                <h2 class="h4 mb-0">Ingredients</h2>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% for ingredient in ingredients %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ ingredient.name }}
                        <span class="badge bg-primary rounded-pill">{{ ingredient.measure }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="card-footer">
                <div class="d-grid gap-2">
                    <button id="favoriteBtn" class="btn btn-outline-danger mb-2" data-meal-id="{{ meal.idMeal }}" data-meal-name="{{ meal.strMeal }}" data-meal-thumb="{{ meal.strMealThumb }}">
                        <i class="fa fa-heart"></i> Add to Favorites
                    </button>
                    <a href="{% url 'nearby_restaurants' %}?q={{ meal.strMeal }}" class="btn btn-outline-primary">
                        Find nearby restaurants
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const favoriteBtn = document.getElementById('favoriteBtn');
    
    console.log("Meal detail page loaded, checking favorite status for meal ID:", "{{ meal.idMeal }}");
    
    // Check if meal is already in favorites
    checkFavoriteStatus('{{ meal.idMeal }}');
    
    favoriteBtn.addEventListener('click', function() {
        const mealId = this.getAttribute('data-meal-id');
        const mealName = this.getAttribute('data-meal-name');
        const mealThumb = this.getAttribute('data-meal-thumb');
        
        console.log("Favorite button clicked for meal:", {
            id: mealId,
            name: mealName,
            thumb: mealThumb
        });
        
        if (this.classList.contains('btn-danger')) {
            // Remove from favorites
            console.log("Removing from favorites...");
            removeFavorite(mealId);
        } else {
            // Add to favorites
            console.log("Adding to favorites...");
            addFavorite(mealId, mealName, mealThumb);
        }
    });
    
    function addFavorite(mealId, mealName, mealThumb) {
        // Create form data
        const formData = new FormData();
        formData.append('meal_name', mealName);
        formData.append('meal_thumb', mealThumb);
        
        // Get CSRF token
        const csrfToken = getCookie('csrftoken');
        console.log("CSRF Token:", csrfToken ? "Found" : "Not found");
        
        // Send request
        console.log(`Sending POST request to /meal/${mealId}/favorite/add/`);
        fetch(`/meal/${mealId}/favorite/add/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            console.log("Server response status:", response.status);
            return response.json();
        })
        .then(data => {
            console.log("Server response data:", data);
            if (data.status === 'added' || data.status === 'exists') {
                favoriteBtn.classList.remove('btn-outline-danger');
                favoriteBtn.classList.add('btn-danger');
                favoriteBtn.innerHTML = '<i class="fa fa-heart"></i> Remove from Favorites';
            }
        })
        .catch(error => {
            console.error("Error adding favorite:", error);
        });
    }
    
    function removeFavorite(mealId) {
        // Get CSRF token
        const csrfToken = getCookie('csrftoken');
        console.log("CSRF Token:", csrfToken ? "Found" : "Not found");
        
        // Send request
        console.log(`Sending POST request to /meal/${mealId}/favorite/remove/`);
        fetch(`/meal/${mealId}/favorite/remove/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            console.log("Server response status:", response.status);
            return response.json();
        })
        .then(data => {
            console.log("Server response data:", data);
            if (data.status === 'removed') {
                favoriteBtn.classList.remove('btn-danger');
                favoriteBtn.classList.add('btn-outline-danger');
                favoriteBtn.innerHTML = '<i class="fa fa-heart"></i> Add to Favorites';
            }
        })
        .catch(error => {
            console.error("Error removing favorite:", error);
        });
    }
    
    function checkFavoriteStatus(mealId) {
        console.log(`Checking favorite status for meal ${mealId}`);
        fetch(`/favorites/check/${mealId}/`)
        .then(response => {
            console.log("Check favorite status response:", response.status);
            return response.json();
        })
        .then(data => {
            console.log("Is favorite:", data.is_favorite);
            if (data.is_favorite) {
                favoriteBtn.classList.remove('btn-outline-danger');
                favoriteBtn.classList.add('btn-danger');
                favoriteBtn.innerHTML = '<i class="fa fa-heart"></i> Remove from Favorites';
            }
        })
        .catch(error => {
            console.error("Error checking favorite status:", error);
        });
    }
    
    // Helper function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}